

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<!-- 
    See copyright in README
-->
<!-- MIME TYPE Guidlines and references: http://hixie.ch/advocacy/xhtml -->



    <head>
        <title>ficly writes like brain</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="keywords" content="awesome" />
        <meta name="description" content="" />
        
    </head>
    <body>
        <div id="container">
            
            <div id="escape_worker" style="display:none;"></div>
            
        </div> <!-- end #container -->
    
        
   <script type="text/javascript" charset="utf-8">
       
       
       var iwl_urls = {
           "money" : "http://iwl.me/w/",
           "share" : "http://iwl.me/s/",
           "permalink" : "http://iwl.me/b/"
       }
       
       function localstore( itemKey, itemValue ) {
           // do I need to remove this key first??
           var response = window.localStorage.setItem( itemKey, window.JSON.stringify( itemValue ) );
           return response
       }
       
       function localfetch( itemKey ) {
           var item = window.localStorage.getItem( itemKey )
           try{
               var json_item = JSON.parse(item);
               return json_item
           } catch(e) {
               console.log('Error getting key', itemKey, e)
           }
           return null;                    
       }
       
       
       function params( obj ) {
           var query_string = [];
           //TODO
           // cannot handle arrays or nested objects
           for(var k in obj) {
               query_string.push( k + "=" + encodeURIComponent( obj[k] ) );
           }
           return query_string.join("&")
       }
       
       function ajaxRequest( obj ) {
           var xhr = new XMLHttpRequest(), message;
           xhr.open(obj.type || "GET", obj.url, true);           
           xhr.onreadystatechange = function() {
                if (xhr.readyState == 4) {
                    // do success
                    if(xhr.status!=200) {
                        if(obj.error) obj.error();
                        console.log("status is not 200")
                        return;
                    }
                    try {
                        message = JSON.parse(xhr.responseText)
                    } catch(e) {
                        // NOT JSON
                        message = xhr.responseXML || xhr.responseText
                    }
                    
                    console.log(message)
                    obj.success( message )
                }
           }
           xhr.send( obj.data || null );
           
           return xhr;

       }
       
       /* 
            IWL Specific Hack handler:
                Get the Code for the permalink / share from the HTML response
       */       
       
       
       function parseAffiliateLink( message_string, author ) {
           
           /*
                Sample Case:
                    Here is the URL I am looking for
http://iwl.me/w/d7939cdb" style="font-size:30px;color:#698B22;text-decoration:none">David Foster Wallace</a>                    
           */
           var pattern = '<a href="http:\/\/iwl.me\/[^/]+\/(.*?)".*>'+ author + '<\/a>'
           var regex = new RegExp(pattern);
           var matches = message_string.match(regex)
           console.log("affiliate match", matches)
           return matches && matches[1] || null
       }
       
       function parseIWLTitle( message_string ) {
           var pattern = "<title>I Write Like (.{3,})<\/title>"
           var regex = new RegExp(pattern)
           var matches = message_string.match(regex)
           //console.log("matches", matches)
           return matches && matches[1] || null
       }
       
       function makewikiLinks( wikitext ) {
           
           // fix this:: <ref name=Themes>Brown. Witness statement; Pages 17 & 21.</ref>
           var pattern = /\[\[([^\]\]]{2,})?\]\]/mgi,
               comment_pattern = /(<!--(.*)?-->)/mgi,
               ref_pattern = /(<ref([^>]*)?>([^<]*)?<\/ref>)?/mgi,
               sup_pattern = /(<sup([^>]*)?>([^<]*)?<\/sup>)?/mgi,
               pattern_2 = /''([^'']{2,})?''/mgi,
               pattern_3 = /\{\{([^\}\}]{2,})?\}\}/mgi;

           var ru = "http://en.wikipedia.org/wiki/Wikipedia:IPA_for_Russian",
               en = "http://en.wikipedia.org/wiki/Wikipedia:IPA_for_English",
               ru_lang = "http://en.wikipedia.org/wiki/Russian_language",
               old_date = "http://en.wikipedia.org/wiki/Old_Style_and_New_Style_dates",
               repell = "http://en.wikipedia.org/wiki/Wikipedia:Pronunciation_respelling_key";
           
           
           /*
                Perform a series of REGEXP to change the wikitext into presentation quality.
                    - Drop the TOC
                    - Drop photo and extra meta
                    - Parse down to main body text
                    - Clean out links, citations and references
                    - Clean up some foreign language name issues (missing test cases for all)
                    
                TODO:
                    Refacture this code, it's gross - maybe a yahoo pipe?
                        Upside, only one call, so far 99.9% accuracy for name provided by iwl.me
                    
           */
           
           var finaltext = wikitext.replace( comment_pattern, "")
                                   .replace( ref_pattern, "")
                                   .replace( sup_pattern, "")                                            
                                   .replace(pattern, function(m, key, value) {
               console.log(m, key, value)
               var splits = key.split("|")
               var display_title = splits[1] || splits[0] 
               var link_string =  '<a target="new" href="http://wikipedia.org/wiki/'; 
                   link_string += encodeURIComponent(splits[0]) + '">';
                   link_string += display_title+'</a>';
               return link_string;
           }).replace( pattern_2, function(m, key, value) {
               console.log(m, key, value)
               return '<i>' + key + '</i>'
           }).replace(pattern_3, function(m, key, value) {
                 console.log("matching brackets", m)
                 if( key.toLowerCase().indexOf("cite") === 0 ) {
                     return "";
                 } 
                 var bracket_keys = key.split("|");
                 var k1 = bracket_keys[0].toLowerCase();
                 if(k1 === "pron-en" || k1 === "proneng") {
                     return 'pronounced <a href="'+ en +'">/' + bracket_keys[1] + '/</a>'
                 }
                 
                 if( k1 === "ipa-ru") {
                     return 'pronounced <a href="'+ru+'">'+ bracket_keys[1]+'</a>'
                 }
                 
                 if(k1 === "lang-ru") {
                     return '<a href="'+ru_lang+'">Russion: </a>' + bracket_keys[1];
                 }
                 
                 if(k1 === "ipac-en" || k1 === "audio-ru") {
                     return "";
                 }
                 
                 
                 if(k1 === "respell") {
                    bracket_keys.shift();
                    return '<a href="'+repell+'">' + bracket_keys.join("-") + '</a>' 
                 }
                 
                 //OldStyleDate
                 if(k1 === "oldstyledate") {
                     bracket_keys.shift();
                     var replace_text = "";
                     var old_style = bracket_keys.pop();
                     
                     bracket_keys.splice(1,0,'[<a href="'+old_date+'">O.S.</a> '+old_style+']')
                     return bracket_keys.join(" ");
                     
                 }
                 return bracket_keys[bracket_keys.length] || key;
           });
           
           //.replace("\n\n", '</p><p>')
           /*
               I am going to put the graphs is a temp array
           
           */
           var graphs = finaltext.split("\n\n"), word_count = 0, pos=1;
           for(var i=0; i<graphs.length; i++) {
               var words = graphs[i].split(" ")
               word_count += words.length;
               
               
               if(word_count > 80 ) {
                   break;
               }
               pos+=1
           }
           finaltext = graphs.slice(0,pos).join("</p><p>")

           
           return '<p>' + finaltext + '</p>';
       }                
       
       
       function processwikipediaResponse( json_message, author, page_url, tab_id ) {
           /*
               {"query":{"pages":{"220477":{"pageid":220477,"ns":0,"title":"Cory Doctorow","revisions"
           */
           var pattern = /\{\{.*\}\}/mgi;
           var regex = new RegExp(pattern)
           var j = json_message.query.pages, wikitext;
           for(var k in j) {
               // HAHA
               j[k].title;
               wikitext = j[k].revisions[0]["*"]
               break;
           }
           //console.log(wikitext)
           //clean_text = wikitext.replace(/\\n/gm, "").replace("Infobox", "liar").replace(regex, "")
           var items = wikitext.split("'''")
           
           items.shift();
           var display_text = items.join(' ');
           display_text = makewikiLinks( display_text )
           ///// , clean_text = wikitext.replace("Infobox", "liar").replace(regex, "")
           


           // store wikipedia data elsewhere, save on calls - only like 50 authors
           localstore( author, display_text)
           // Can I send data- 
           // TODO
           // Test if data can be passed directly to script
           //, data : {"foo" : "bar"}
           
           /*
                The Long and winding road
                    Have the tab id of where this request came from to prevent RACE CONDITIONS
                    TODO:
                    Check to see that this tab still exists or otherwise error handle
                    
           */

           addStoryWidget(  tab_id  );
                               
       }
       
       function addStoryWidget( tab_id ) {
           chrome.tabs.insertCSS(tab_id, {file : "css/ficly_story_widget.css"})
           chrome.tabs.executeScript(tab_id, {file: "js/content_scripts/ficly_story_widget.js"});           
       }
       
       function iwl_response_handler(  response, callback, page_url, tab_id ) {

           var iwl_author = parseIWLTitle( response ),
               affiliate_link = parseAffiliateLink( response, iwl_author );
           console.log("more stuff", iwl_author, affiliate_link, page_url )
       
           // save to local storage
           var data = {
               'author' : iwl_author,
               'link' : affiliate_link
           };
           localstore( page_url, data )
           
           callback( data );           

           // 
           console.log("finish processing")
           var wikipedia_author_data = localfetch( iwl_author );
           if(!wikipedia_author_data) {
               makeWikiRequest( iwl_author, page_url, tab_id )
           } else {
               console.log("fetching from cache", iwl_author)
               addStoryWidget( tab_id  );
           }


       }       
       
       
       /*
            Connections Section:
            
                Connect Wikipedia
                Connect IWL (getting HTML back)
                Connect to content script: message_dispatcher.js
                Connect to  content_script: ficly_story_widget.js
       */
       

       
       function makeWikiRequest( author, page_url, tab_id ) {
           // fix this to combine with makeresponse - pass in a URL as first arg instead... whatever
           var wiki_params = {
               action : "query",
               prop : "revisions",
               rvprop : "content",
               rvsection : 0,
               format : "json",
               titles : author
           }
           ajaxRequest({
               url : "http://en.wikipedia.org/w/api.php?" + params( wiki_params ),
               success : function(jo) {
                   processwikipediaResponse( jo, author, page_url, tab_id )
               }
           });           
       }
       
       function makeIWLRequest( message, permalink, callback ) {
           var worker = document.getElementById("escape_worker");
           worker.innerHTML = message
           
           var safe_message = worker.innerText, 
                iwl_params = {
                    text : safe_message, 
                    'permalink' : permalink
                };
                
                //
           
           ajaxRequest({
              url : 'http://iwl.me/?' + params(iwl_params),
              type : "POST",
              success : callback
           });
                  
       }
       

       
       chrome.extension.onRequest.addListener(function( request, sender, sendResponse ) {
           if(!request.content) return;
           console.log(request, "in brain", sender);
           
           makeIWLRequest( request.content, sender.tab.url, function(response) {
               // process page message
               //TODO
               // yuck too much nesting, clean this up later
               iwl_response_handler(response, sendResponse, sender.tab.url, sender.tab.id);
           })
           // save the tab id and URL of this page so I can return it correctly
       });

       
       chrome.extension.onRequest.addListener(function( request, sender, sendResponse) {
            if(!request.action) return;
            
            switch(request.action) {
                
                case "injectAuthorWidget":
                    chrome.tabs.executeScript(sender.tab.id, {file: "js/content_scripts/ficly_author_widget.js"});                     
                break;
                
                case "buildWidget":
                    var data = localfetch(  sender.tab.url )
                    data.base_urls = iwl_urls;
                    data.wikitext = localfetch( data.author );
                    sendResponse( data )                    
                break;
                
                case "buildAuthorWidget":
                    console.log("author widget alive", request, request.links)
                    //TODO
                    // call local storage for these values
                    // assemble a response
                    // return
                    sendResponse({"foo" : "bar"})
                break;
                
                default:
                    // fall throw
                break;
                
            }
           
       });              
       
       
       
   </script>


    </body>
</html>
